---

- name: Create user nobody for fastd
  user:
    name: nobody
    shell: '/bin/false'
    createhome: no

- name: Create fastd directory
  file:
    path: '/etc/fastd'
    state: directory
    mode: 'u=rwx,g=rx,o=rx'

- name: Create 'fastd/peers' directory
  file:
    path: '/etc/fastd/peers'
    state: directory
    mode: 'u=rwx,g=rx,o=rx'

- name: Create 'fastd/backbone' directory
  file:
    path: '/etc/fastd/backbone'
    state: directory
    mode: 'u=rwx,g=rx,o=rx'

- name: Copy fastd configurations
  copy:
    src: 'files/fastd/fastd.conf'
    dest: '/etc/fastd/fastd.conf'
    owner: nobody
    group: root
    mode: 'u=rwx,g=rx,o=rx'

- name: Copy fastd vpn-backbone configurations
  copy:
    src: 'files/fastd/backbone/{{ item }}'
    dest: '/etc/fastd/backbone/{{ item }}'
    owner: nobody
    group: root
    mode: 'u=rwx,g=rx,o=rx'
  with_items:
    '{{ fastd_vpn_backbone_configs }}'

- name: Create fastd private key pair
  shell: 'fastd_secret= "{{ fastd_secret }}";if [ -z "$fastd_secret" ]; then fastd_secret=$(fastd --generate-key --machine-readable); fi; echo "secret \"$fastd_secret\";" >> /etc/fastd/fastd.conf; fastd_key=$(echo "secret \"$fastd_secret\";" | fastd --config - --show-key --machine-readable); echo "#key \"$fastd_key\";" >> /etc/fastd/fastd.conf; sed -i "s/eth0/$wan_iface/g" /etc/fastd/fastd.conf; sed -i "s/eth0/{{ wan_interface }}/g" /etc/fastd/fastd.conf'
  args:
    chdir: '/etc/fastd'
